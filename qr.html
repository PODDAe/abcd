<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>DTZ NOVA X MD | QR Pair</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1: #0f172a;
      --bg2: #0b1020;
      --accent1: #ff3b3b;
      --accent2: #ff0000;
      --glass: rgba(0, 0, 0, 0.06);
      --glass-2: rgb(255, 255, 255);
      --radius: 18px;
      --text: #000000;
      --muted: rgba(255,255,255,0.7);
      --success: #32cd32;
      --transition: 300ms cubic-bezier(.2,.9,.3,1);
      --max-width: 460px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
    html,body{height:100%}
    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      color:var(--text);
      background:linear-gradient(120deg,var(--bg1),var(--bg2));
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .bg-anim{
      position:fixed;inset:0;z-index:-3;
      background-image: url('https://files.catbox.moe/g1zze2.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: blur(18px) saturate(120%);
      transform: scale(1.02);
      opacity:.95;
    }
    .bg-overlay{
      position:fixed;inset:0;z-index:-2;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(255,60,60,0.06), transparent 6%),
                  radial-gradient(900px 500px at 90% 85%, rgba(120,0,0,0.03), transparent 6%);
      pointer-events:none;
    }
    .card{
      width:100%;
      max-width:var(--max-width);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border-radius:var(--radius);
      padding:28px 20px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6), 0 2px 8px rgba(0,0,0,0.5);
      backdrop-filter: blur(10px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.04);
      position:relative;
      overflow:hidden;
      transform-origin:center;
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .card:active{ transform: translateY(2px) scale(.998) }
    .top{ display:flex; align-items:center; gap:14px; margin-bottom:14px; }
    .avatar{
      width:84px;height:84px;border-radius:50%;
      display:inline-flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      box-shadow:0 8px 30px rgba(255,30,30,0.12), inset 0 -6px 18px rgba(0,0,0,0.18);
      border:4px solid rgba(255,255,255,0.06);
      flex-shrink:0;
      transition: transform var(--transition);
      overflow:hidden;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .title{
      font-weight:700;font-size:20px; line-height:1.05;
      -webkit-background-clip:text;background-clip:text;
      background: linear-gradient(90deg,var(--accent1),var(--accent2));
      color:transparent;
    }
    .subtitle{ font-size:13px; color:var(--muted); margin-top:6px }
    .controls{ margin-top:8px; display:flex; gap:12px; flex-direction:column; align-items:stretch }
    .qr-container{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:20px;
      padding:20px;
    }
    #qrCode{
      width:280px;
      height:280px;
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 8px 25px rgba(0,0,0,0.3);
    }
    .qr-instructions{
      text-align:center;
      color:var(--muted);
      font-size:14px;
      line-height:1.5;
    }
    .btn{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:none;
      font-weight:600;
      font-size:16px;
      cursor:pointer;
      background: linear-gradient(90deg,var(--accent1),var(--accent2));
      color:white;
      box-shadow: 0 10px 30px rgba(255,30,30,0.14);
      transition: transform var(--transition), box-shadow var(--transition);
      text-decoration:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn:active{ transform: translateY(2px) }
    .btn-secondary{
      background: linear-gradient(90deg, #333, #555);
      box-shadow: 0 10px 30px rgba(0,0,0,0.14);
    }
    .status{
      margin-top:14px;
      min-height:54px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-direction:column;
    }
    .audio-toggle{
      position:fixed; right:18px; bottom:18px; z-index:40;
      width:56px;height:56px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(180deg, rgba(255,40,40,0.95), rgba(255,20,20,0.95));
      box-shadow:0 12px 30px rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.06);
      color:white; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    #rcMsg{
      display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.7);padding:12px 20px;border-radius:12px;
      border:1px solid rgba(255,60,60,0.18);color:var(--accent2);font-weight:600;
      z-index:60;
    }
    @media (max-width:480px){
      :root{ --max-width: 420px }
      .card{ padding:20px; border-radius:16px }
      .avatar{ width:72px;height:72px }
      .title{ font-size:18px }
      #qrCode{ width:240px; height:240px }
      .audio-toggle{ width:50px;height:50px;border-radius:12px;right:14px;bottom:14px }
    }
    .waiting{ color:var(--muted); font-weight:600 }
    .success{ color:var(--success); font-weight:700 }
  </style>
</head>
<body>
  <div class="bg-anim" aria-hidden="true"></div>
  <div class="bg-overlay" aria-hidden="true"></div>

  <main class="card" role="main" aria-labelledby="qr-title">
    <div class="top" aria-hidden="false">
      <div class="avatar" aria-hidden="true">
        <img src="https://files.catbox.moe/g1zze2.jpg" alt="DTZ NOVA X MD">
      </div>
      <div style="flex:1;text-align:left">
        <div id="qr-title" class="title">DTZ NOVA X MD</div>
        <div class="subtitle">QR Code Pairing</div>
      </div>
    </div>

    <div class="controls" aria-live="polite">
      <div class="qr-container">
        <div id="qrCode"></div>
        <div class="qr-instructions">
          <p><strong>ðŸ“± How to pair:</strong></p>
          <p>1. Open WhatsApp on your phone</p>
          <p>2. Tap â‹® â†’ Linked Devices</p>
          <p>3. Tap Link a Device</p>
          <p>4. Scan this QR code</p>
        </div>
      </div>
      
      <div id="status" class="status">
        <span class="waiting">Generating QR code...</span>
      </div>

      <div style="display:flex; gap:10px; margin-top:15px;">
        <a href="/pair" class="btn btn-secondary">
          <i class="fas fa-phone"></i> Phone Pair
        </a>
        <a href="/" class="btn btn-secondary">
          <i class="fas fa-home"></i> Home
        </a>
      </div>
    </div>
  </main>

  <button id="audioToggle" class="audio-toggle" aria-pressed="false" title="Toggle background audio">
    <i id="audioIcon" class="fas fa-play"></i>
  </button>

  <div id="rcMsg" role="status">DTZ NOVA X MD Â© 2025 | Developer: Dulina Nethmira</div>

  <audio id="bgAudio" src="https://files.catbox.moe/l2owr6.mp3" loop preload="none" playsinline crossorigin="anonymous">
    <source src="https://files.catbox.moe/l2owr6.mp3" type="audio/mpeg">
  </audio>

  <script>
    const qrCode = document.getElementById('qrCode');
    const status = document.getElementById('status');
    const audio = document.getElementById('bgAudio');
    const audioToggle = document.getElementById('audioToggle');
    const audioIcon = document.getElementById('audioIcon');
    const rcMsg = document.getElementById('rcMsg');

    let isPlaying = false;
    let currentSessionId = null;
    let connectionCheckInterval = null;

    // Generate QR Code
    async function generateQRCode() {
      try {
        status.innerHTML = `<span class="waiting">Generating QR code...</span>`;
        
        const response = await fetch('/api/code/qr');
        const data = await response.json();
        
        if (data.success) {
          qrCode.innerHTML = `<img src="${data.qrCode}" alt="WhatsApp QR Code" style="width:100%;height:100%;border-radius:8px;">`;
          status.innerHTML = `<span class="waiting">Scan the QR code with WhatsApp</span>`;
          currentSessionId = data.sessionId;
          
          // Start checking connection status
          startConnectionCheck();
        } else {
          status.innerHTML = `<span style="color:#ff8b8b;font-weight:700">Failed to generate QR code</span>`;
        }
      } catch (error) {
        console.error('QR generation error:', error);
        status.innerHTML = `<span style="color:#ff8b8b;font-weight:700">Error generating QR code</span>`;
      }
    }

    // Check connection status
    function startConnectionCheck() {
      if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
      }
      
      connectionCheckInterval = setInterval(async () => {
        if (!currentSessionId) return;
        
        try {
          const response = await fetch(`/api/code/status/${currentSessionId}`);
          const data = await response.json();
          
          if (data.success && data.connected) {
            status.innerHTML = `<span class="success">âœ… Connected successfully!</span>`;
            clearInterval(connectionCheckInterval);
            
            // Show success message
            setTimeout(() => {
              status.innerHTML += `<div style="margin-top:10px;color:var(--muted);font-size:12px;">You can close this page now</div>`;
            }, 1000);
          }
        } catch (error) {
          console.error('Status check error:', error);
        }
      }, 2000);
    }

    // Audio controls
    audioToggle.addEventListener('click', async () => {
      if (!isPlaying) {
        try { await audio.play(); isPlaying = true; audioIcon.className = 'fas fa-pause'; audioToggle.setAttribute('aria-pressed','true'); }
        catch(e) { isPlaying = false; }
      } else {
        audio.pause(); isPlaying = false; audioIcon.className = 'fas fa-play'; audioToggle.setAttribute('aria-pressed','false');
      }
    });

    function tryPlayAudio() {
      try {
        audio.preload = 'auto';
        audio.crossOrigin = 'anonymous';
        audio.play().then(() => {
          isPlaying = true;
          audioIcon.className = 'fas fa-pause';
          audioToggle.setAttribute('aria-pressed','true');
        }).catch(() => {});
      } catch (e) {}
    }

    document.addEventListener('pointerdown', (e) => { tryPlayAudio(); }, { once:true, passive:true });

    // Right click message
    document.addEventListener('contextmenu', (e) => { e.preventDefault(); rcMsg.style.display = 'block'; setTimeout(()=> rcMsg.style.display = 'none', 1600); });
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('dragstart', e => e.preventDefault());

    // Initialize QR code
    generateQRCode();

    // Auto-refresh QR code every 2 minutes
    setInterval(() => {
      if (!currentSessionId) {
        generateQRCode();
      }
    }, 120000);
  </script>
</body>
</html>
